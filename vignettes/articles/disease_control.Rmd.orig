---
title: "scMultiMap for disease-control studies"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette illustrates applying `scMultiMap` to infer peak-gene pairs that are differentially associated using single-cell multimodal data from disease-control studies.

```{r setup, warning = FALSE, message = FALSE}
library(scMultiMap)
library(Signac)
library(Seurat)
```

In [scMultiMap manuscript](https://www.biorxiv.org/content/10.1101/2024.09.24.614814v1), we applied a permutation procedure to identify significantly differentially associated peak-gene pairs between microglia from healthy control subjects and subjects with Alzheimer's disease (Results section "scMultiMap mapped GWAS variants of Alzheimerâ€™s disease to target genes in microglia"). We illustrate the codes for this analysis here.

# 1. Load pre-processed data

We used the same brain single-cell multiome dataset as in the paper, which was downloaded from [GSE214979](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE214979). We further re-called peaks by cell types with MACS2 using the codes at the [scMultiMap reproducibility Github repo](https://github.com/ChangSuBiostats/scMultiMap_analysis/preprocessing/preprocess_10x_PBMC_data.R). Calling peaks by cell types generates cell-type-specific peaks that better represent candidate enhancers than calling peaks with all cell types merged, which may obscure signals from less abundant cell types such as microglia. Using MACS2 provides the fragment counts necessary for running scMultiMap (see discussion [here](scMultiMap.html)).

```{r eval=F, include=T}
data_dir <- '../../../data'
obj <- readRDS(sprintf('%s/processed_AD_DLPFC_15.rds', data_dir))
# subset to microglia
ct <- 'Microglia'
ct_obj <- subset(x = obj, subset = predicted.id == ct)
```

```{r include=F}
data_dir <- '../../../data'
ct_obj <- readRDS(sprintf('%s/Microglia_seurat_obj.rds', data_dir))
```

In this analysis, we study the top $5{,}000$ highly expressed genes and top $50{,}000$ highly accessible peaks in CD14 Monocytes, and use a cis-region of width 1Mb to define candidate peak-gene pairs.

```{r}
# We used only control cells in the original study to select peak-gene pairs for scMultiMap analysis
# For reproducing the results in the paper, we keep it consistent here,
#  while recognizing that it also makes sense to use microglia from all samples.
pairs_df <- get_top_peak_gene_pairs(subset(x = ct_obj, subset = Diagnosis == 'Unaffected'),
                                    gene_top=5000, peak_top=50000,
                                    distance = 5e+5,
                                    gene_assay = 'RNA', # name of the gene assay
                                    peak_assay = 'peaks') # name of the peak assay
```

Here, we generated `r nrow(pairs_df)` candidate peak-gene pairs generated based on the criterion above. Generally, the pairs to be studied could also be customized and supplied by users.

# 3. Differential association analysis

First, we obtain peak-gene associations in microglia from the control and the Alzheimer's disease groups, respectively.

```{r}
# control
control_res <- scMultiMap(subset(x = ct_obj, subset = Diagnosis == 'Unaffected'), pairs_df,
                          gene_assay = 'RNA', # name of the gene assay
                          peak_assay = 'peaks') # name of the peak assay

# disease
disease_res <- scMultiMap(subset(x = ct_obj, subset = Diagnosis == "Alzheimer's"), pairs_df,
                          gene_assay = 'RNA', # name of the gene assay
                          peak_assay = 'peaks') # name of the peak assay
```

Calculating the difference between two estimates ("observed difference") gives the magnitude of differential association. To test whether the difference is statistically significant, we adopt a permutation test that randomly permutes **sample labels** for 100 times to construct a null distribution of difference between groups ("null difference").


```{r}
# obtain the status for each id (sample)
Status_id_tab <- table(ct_obj$id, ct_obj$Status)
Status_ids <- lapply(1:2, function(i) rownames(Status_id_tab)[Status_id_tab[,i] > 0])

# randomly select 7 AD sample labels from 15 samples
all_comb <- combn(rownames(Status_id_tab), length(Status_ids[[1]]))
set.seed(2024)
n_permu <- 2
# randomly permute sample labels for disease/control
random_combs <- sample(1:ncol(all_comb), n_permu, replace = F)
```

We then generated a permutation $p$-value by evaluating the proportion of times that the "observed difference" is larger than the "null difference".

```{r}
# See http://127.0.0.1:9111/notebooks/group_dir/scGRN/analysis/real_data/Differential%20analysis-checkpoint.ipynb

diff_mat <- matrix(nrow = nrow(control_res), ncol = n_permu)
for(i_permu in 1:n_permu){
  # obtain randomly shuffled sample labels
  disease_sams <- all_comb[,random_combs[i_permu]]
  control_sams <- rownames(Status_id_tab)[!rownames(Status_id_tab) %in% disease_inds]
  # control
  null_control <- scMultiMap(subset(x = ct_obj, subset = id %in% control_sams), pairs_df,
                          gene_assay = 'RNA', # name of the gene assay
                          peak_assay = 'peaks') # name of the peak assay

  # disease
  null_disease <- scMultiMap(subset(x = ct_obj, subset = id %in% disease_sams), pairs_df,
                          gene_assay = 'RNA', # name of the gene assay
                          peak_assay = 'peaks') # name of the peak assay

  # null difference, i_permu
  diff_mat[,i_permu] <- null_disease[,'covar'] - null_control[,'covar']
}
```

```{r}
obs_diff <- disease_res[,'covar'] - control_res[,'covar']
pval1 <- rowMeans(obs_diff > diff_mat)
pval2 <- rowMeans(obs_diff < diff_mat)
permu_pval <- pmin(pval1, pval2) * 2
```

# 4. Visualization and downstream analysis of differentially associated peak-gene pairs

First, we visualize the differential associations with a heatmap as in Figure 4b in the paper.

```{r}

```

We further integrated information from differential expression and use a Gene Ontology enrichment analysis to investigate the biological pathways implicated.

```{r}

```

These differentially peak-gene pairs can also be jointly analyzed with GWAS (Genome-wide association studies) results, to shed light on the cell-type-specific regulatory mechanisms of GWAS hits. Please see [scMultiMap for interpreting GWAS results](GWAS.html), a separate vignette that uses differentially associated peak-gene pairs identified here to interpret the function of causal variants of Alzheimer's disease GWAS in microglia.

